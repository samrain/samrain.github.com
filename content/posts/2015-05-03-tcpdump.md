---
layout : post
category : work
tags : [linux, 通信, 报文, tcpdump]
title : Tcpdump介绍
date : 2015-05-03
---


## Why
看到一个F5的兄弟解决生产问题时，用Wireshark排查问题之前都是在Server上输入一串命令，然后FTP下载到本地来。偷偷看了下，原来那串命令就是`tcpdump XXXX`，很神奇。
由于平常工作偶尔也会用到Wireshark，不过一般都是在Windows上，很少在Linux下用，所以很好奇`tcpdump`。

## What

- **定义**：dump the traffice on a network，根据使用者的定义对网络上的数据包进行截获的包分析工具。
- [官网在此](http://www.tcpdump.org/)
- [Github](https://github.com/the-tcpdump-group/tcpdump)
- 如何安装请看官网说明（在Ubuntu1410上默认安装了）。
- 参数请见`man tcpdump`，以下是摘录网上的中文介绍：

> -A 以ASCII格式打印出所有分组，并将链路层的头最小化。

> -c 在收到指定的数量的分组后，tcpdump就会停止。

> -C 在将一个原始分组写入文件之前，检查文件当前的大小是否超过了参数file_size 中指定的大小。如果超过了指定大小，则关闭当前文件，然后在打开一个新的文件。参数 file_size 的单位是兆字节（是1,000,000字节，而不是1,048,576字节）。

> -d 将匹配信息包的代码以人们能够理解的汇编格式给出。

> -dd 将匹配信息包的代码以c语言程序段的格式给出。

> -ddd 将匹配信息包的代码以十进制的形式给出。

> -D 打印出系统中所有可以用tcpdump截包的网络接口。

> -e 在输出行打印出数据链路层的头部信息。

> -E 用spi@ipaddr algo:secret解密那些以addr作为地址，并且包含了安全参数索引值spi的IPsec ESP分组。

> -f 将外部的Internet地址以数字的形式打印出来。

> -F 从指定的文件中读取表达式，忽略命令行中给出的表达式。

> -i 指定监听的网络接口。

> -l 使标准输出变为缓冲行形式，可以把数据导出到文件。

> -L 列出网络接口的已知数据链路。

> -m 从文件module中导入SMI MIB模块定义。该参数可以被使用多次，以导入多个MIB模块。

> -M 如果tcp报文中存在TCP-MD5选项，则需要用secret作为共享的验证码用于验证TCP-MD5选选项摘要（详情可参考RFC 2385）。

> -b 在数据-链路层上选择协议，包括ip、arp、rarp、ipx都是这一层的。

> -n 不把网络地址转换成名字。

> -nn 不进行端口名称的转换。

> -N 不输出主机名中的域名部分。例如，‘nic.ddn.mil‘只输出’nic‘。

> -t 在输出的每一行不打印时间戳。

> -O 不运行分组分组匹配（packet-matching）代码优化程序。

> -P 不将网络接口设置成混杂模式。

> -q 快速输出。只输出较少的协议信息。

> -r 从指定的文件中读取包(这些包一般通过-w选项产生)。

> -S 将tcp的序列号以绝对值形式输出，而不是相对值。

> -s 从每个分组中读取最开始的snaplen个字节，而不是默认的68个字节。

> -T 将监听到的包直接解释为指定的类型的报文，常见的类型有rpc远程过程调用）和snmp（简单网络管理协议；）。

> -t 不在每一行中输出时间戳。

> -tt 在每一行中输出非格式化的时间戳。

> -ttt 输出本行和前面一行之间的时间差。

> -tttt 在每一行中输出由date处理的默认格式的时间戳。

> -u 输出未解码的NFS句柄。

> -v 输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息。

> -vv 输出详细的报文信息。

> -w 直接将分组写入文件中，而不是不分析并打印出来。

- 过滤报文用的表达式关键字
    - 类型
	    - host
	    `host 192.168.1.100`指的是一台主机
	    - net
	    `net 192.168.0.0/24`指的是一个网络地址
	    - port
	    `port 8080`指的是端口号是23
    - 传输方向
	    - src
	    `src 192.168.1.100`指的是源地址
	    - dst
	    `dst net 192.168.0.0/24`指的是目的地址
	    - dst or src
	    **缺省关键字**
	    - dst and src
    - 协议
    如果没有指定任何协议，那么监听所有协议的信息包。
	    - fddi
	    ether的包进行处理和分析
	    - ip
	    - arp
	    - rarp
	    - tcp
	    - udp
	- 其他
	除了这三种类型的关键字之外，其他重要的关键字如下：gateway， broadcast，less， greater， 还有三种逻辑运算，取非运算是`not !`， 与运算是`and`，`&&`或运算是`or` ，`||` 这些关键字可以组合起来构成强大的组合条件来满足人们的需要。

## Where

一般都是在Linux/freebsd上使用。

## When

- 排查网络问题
- 排查应用问题（当没有日志或者日志很少，特别是2个以上系统之间的信息交互问题）

## Who

- 运维人员
- 开发人员

## How

我的一般用法：

- 在Server上运行

<script src="https://gist.github.com/samrain/c2929e3132350edd6ebb.js"></script>

- 用FTP/SFTP下载到PC上。
- 在PC上运行`wireshark`，然后读取从服务器下载的dump文件进行分析
